# 指示内容
## 実現すべき目標
1. コードの可読性の向上
2. 機能の保守性・信頼性の向上

## 具体的に必要な作業
- 各ファイルごとの問題点の診断
- 単一責任の原則による責務の分離
- 各コンポーネントの疎結合化
- ハードコードの解決
- 関数・変数の整理
- 記述の順序の整理
- コメントの整理・日本語化

## 【**最重要**】絶対に守るべき制約
- 本リファクタリングに先立ち、必ず現行コードの状態を基準（ベースライン）として記録してください。具体的には、主要なユーザーフローが正常に動作することを確認したうえで、パフォーマンス指標（Lighthouse 等による計測結果）および画面表示結果を取得・保存し、リファクタリング後はこれらと比較して同等以上であることを確認するものとします。
- リファクタリング後の受け入れ条件は、主観的な判断ではなく、定量的・機械的に検証可能な基準によって判定してください。既存の機能がすべて動作すること、UI表示が変更されていないこと、ならびにパフォーマンス指標が悪化していないことを、テストや計測結果によって明示的に確認する必要があります。
- すべての修正作業は、現行コードを直接変更せず、新規ブランチ上で行ってください。変更は論理的に意味のある単位で管理し、どのような意図でどの部分を修正したのかが後から追跡できる状態を維持してください。元の状態へ確実に戻せることは、本リファクタリングの前提条件とします。
- リファクタリングの過程および結果については、修正前後の差分が明確に分かる形で整理してください。特に、可読性・保守性・パフォーマンスの観点で、どの問題がどのように解決されたのかを説明可能な状態にしておくことを求めます。
- 最終的な成果物として、修正されたすべてのファイルに加え、実施した変更の一覧、検証結果、および既存機能・UIが維持されていることを確認した根拠を提示してください。これらが揃って初めて、今回のリファクタリングは完了と見なされます。

## リファクタリング対象ファイル一覧

### メインファイル（リファクタリング対象）

| ファイル名 | サイズ | 説明 |
|-----------|--------|------|
| app.js | 90,321 bytes | メインアプリケーションロジック |
| index.html | 25,554 bytes | HTMLファイル |
| style.css | 36,091 bytes | CSSスタイルシート |
| translations.js | 13,420 bytes | 多言語翻訳ファイル |
| firebase-config.js | 1,855 bytes | Firebase設定ファイル |
| firebase-messaging-sw.js | 2,258 bytes | FCM Service Worker |
| service-worker.js | 3,394 bytes | PWA Service Worker |

### Cloud Functions（リファクタリング対象）

| ファイル名 | サイズ | 説明 |
|-----------|--------|------|
| functions/index.js | 10,806 bytes | Cloud Functions エントリーポイント |

### 設定ファイル（参考・必要に応じて修正）

| ファイル名 | サイズ | 説明 |
|-----------|--------|------|
| manifest.json | 533 bytes | PWAマニフェスト |
| firebase.json | 283 bytes | Firebaseホスティング設定 |
| .firebaserc | 67 bytes | Firebaseプロジェクト設定 |
| functions/.eslintrc.js | 492 bytes | ESLint設定 |
| functions/package.json | 638 bytes | npm依存関係設定 |

### 対象外ファイル

以下のファイルはリファクタリング対象外とします。

- `.git/` - Gitリポジトリ
- `.gitignore` - Git除外設定
- `README.md` - プロジェクト説明
- `habit-tracker-requirements.md` - 要件定義
- `refactoring-instructions.md` - 本ファイル
- `logs/` - ログディレクトリ
- `node_modules/` - 依存モジュール
- `package-lock.json` - パッケージロック
- `favicon.ico`, `icon-192.png`, `icon-512.png` - アイコン画像

---

## 作業計画（Work Plan）

### フェーズ1: 準備作業（Preparation）

#### 1.1 新規ブランチの作成
```bash
git checkout -b refactoring/comprehensive-cleanup
```

#### 1.2 ベースライン記録
以下の項目を記録し、リファクタリング後の比較基準とする。

| 項目 | 記録内容 | 保存先 |
|------|---------|--------|
| 機能動作確認 | 主要ユーザーフローの動作スクリーンショット | `logs/baseline/screenshots/` |
| Lighthouse計測 | Performance, Accessibility, Best Practices, SEO スコア | `logs/baseline/lighthouse.json` |
| コンソールエラー | エラー・警告の有無 | `logs/baseline/console.log` |

**主要ユーザーフロー（検証対象）:**
1. アプリ起動・初期表示
2. 習慣の追加・編集・削除
3. 習慣の完了チェック
4. カテゴリ管理
5. 統計・グラフ表示
6. 設定変更（言語切替・通知設定等）
7. データのエクスポート/インポート

#### 1.3 成果物
- [x] ブランチ `refactoring/comprehensive-cleanup` の作成
- [ ] ベースラインスクリーンショット
- [ ] Lighthouse計測結果

---

### フェーズ2: 診断・分析（Diagnosis）

#### 2.1 各ファイルの問題点診断
対象ファイルごとに以下の観点で問題点を洗い出す。

| 観点 | チェック内容 |
|------|-------------|
| 単一責任の原則 | 1つのファイル/関数が複数の責務を持っていないか |
| 疎結合性 | モジュール間の依存関係が適切か |
| ハードコード | マジックナンバー・文字列リテラルの直接記述 |
| 命名規則 | 関数・変数名が明確で一貫しているか |
| コード重複 | 同様のロジックが複数箇所に存在しないか |
| コメント | 適切なコメントがあるか、不要なコメントがないか |

#### 2.2 リファクタリング優先順位の決定
以下の基準で優先順位を決定する。

1. **高優先度**: 複雑度が高く、バグが発生しやすい箇所
2. **中優先度**: 可読性が低いが、機能は安定している箇所
3. **低優先度**: 軽微な改善で十分な箇所

#### 2.3 成果物
- [ ] ファイル別問題点一覧
- [ ] リファクタリング優先順位表

---

### フェーズ3: 実装（Implementation）

#### 3.1 実装順序
依存関係を考慮し、以下の順序で実装する。

| 順序 | ファイル | 理由 |
|------|---------|------|
| 1 | `firebase-config.js` | 他ファイルからの依存が少ない |
| 2 | `translations.js` | 独立したデータファイル |
| 3 | `service-worker.js` | 独立したWorker |
| 4 | `firebase-messaging-sw.js` | 独立したWorker |
| 5 | `functions/index.js` | バックエンド、フロントと分離 |
| 6 | `style.css` | ロジックなし、構造整理のみ |
| 7 | `index.html` | app.jsとの整合性を確認しながら |
| 8 | `app.js` | 最大・最複雑、最後に実施 |

#### 3.2 各ファイルの実装方針
各ファイルのリファクタリング完了後、以下を確認する。

- [ ] 構文エラーがないこと
- [ ] コンソールエラーが発生しないこと
- [ ] 該当機能が正常に動作すること

#### 3.3 コミット戦略
各ファイルのリファクタリング完了ごとにコミットを作成する。

```
git commit -m "refactor(ファイル名): 変更内容の要約"
```

---

### フェーズ4: 検証（Verification）

#### 4.1 機能テスト
フェーズ1で記録した主要ユーザーフローを再度実行し、全て正常に動作することを確認する。

| テスト項目 | 期待結果 | 結果 |
|-----------|---------|------|
| アプリ起動・初期表示 | 正常表示 | - |
| 習慣の追加・編集・削除 | CRUD操作が正常動作 | - |
| 習慣の完了チェック | チェック状態が保存される | - |
| カテゴリ管理 | カテゴリCRUDが正常動作 | - |
| 統計・グラフ表示 | グラフが正しく描画される | - |
| 設定変更 | 設定が保存・反映される | - |
| データエクスポート/インポート | データの入出力が正常 | - |

#### 4.2 UI表示確認
リファクタリング前後のスクリーンショットを比較し、視覚的な差異がないことを確認する。

#### 4.3 パフォーマンス計測
Lighthouseで再計測し、ベースラインと比較する。

| 指標 | ベースライン | リファクタリング後 | 判定 |
|------|-------------|------------------|------|
| Performance | - | - | - |
| Accessibility | - | - | - |
| Best Practices | - | - | - |
| SEO | - | - | - |

**受け入れ条件**: 全指標がベースライン以上であること

---

### フェーズ5: 完了・ドキュメント（Completion）

#### 5.1 成果物一覧
- [ ] リファクタリング済みファイル一式
- [ ] 変更一覧（ファイル別、変更内容の要約）
- [ ] 検証結果レポート（機能テスト、UI比較、Lighthouse結果）
- [ ] 修正前後の差分説明

#### 5.2 最終レビュー
- [ ] 全コミットの確認
- [ ] mainブランチへのマージ準備

#### 5.3 完了条件チェックリスト
- [ ] 既存の機能がすべて動作すること
- [ ] UI表示が変更されていないこと
- [ ] パフォーマンス指標が悪化していないこと
- [ ] 変更の追跡可能性が維持されていること
- [ ] 元の状態へ確実に戻せること

---

## 進捗管理

| フェーズ | ステータス | 開始日 | 完了日 |
|---------|-----------|--------|--------|
| フェーズ1: 準備 | 未着手 | - | - |
| フェーズ2: 診断 | 未着手 | - | - |
| フェーズ3: 実装 | 未着手 | - | - |
| フェーズ4: 検証 | 未着手 | - | - |
| フェーズ5: 完了 | 未着手 | - | - |
